<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        direction: rtl;
        padding: 20px;
      }
      .navbar {
        background: white;
        padding: 20px;
        margin-bottom: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .navbar h1 {
        color: #333;
        font-size: 24px;
      }
      .navbar button {
        background: #dc3545;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
      }
      .navbar button:hover {
        background: #c82333;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
        margin-bottom: 30px;
      }
      .profile-card {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
      .profile-image {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin-bottom: 20px;
        background: #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 48px;
        margin-left: auto;
        margin-right: auto;
        overflow: hidden;
        border: 3px solid #667eea;
      }
      .profile-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .profile-info {
        text-align: right;
        margin-bottom: 20px;
      }
      .profile-info h2 {
        color: #333;
        margin-bottom: 5px;
      }
      .profile-info p {
        color: #666;
        margin-bottom: 8px;
      }
      .bio {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        color: #666;
        line-height: 1.6;
        margin-bottom: 20px;
        text-align: right;
      }
      .tabs {
        display: flex;
        gap: 10px;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .tab-btn {
        padding: 10px 20px;
        background: #e0e0e0;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        color: #333;
        transition: all 0.2s;
      }
      .tab-btn.active {
        background: #667eea;
        color: white;
      }
      .tab-btn:hover {
        background: #667eea;
        color: white;
      }
      .tab-content {
        display: none;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .tab-content.active {
        display: block;
      }
      .message-item {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        transition: background 0.2s;
      }
      .message-item:hover {
        background: #f5f5f5;
      }
      .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      .message-header strong {
        color: #333;
      }
      .message-header span {
        color: #999;
        font-size: 12px;
      }
      .message-body {
        color: #666;
        line-height: 1.5;
      }
      .admin-section {
        background: #fff3cd;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #ffeaa7;
        margin-bottom: 20px;
      }
      .admin-section h3 {
        color: #856404;
        margin-bottom: 15px;
      }
      .approval-item {
        background: white;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        border-right: 4px solid #667eea;
      }
      .approval-item h4 {
        color: #333;
        margin-bottom: 8px;
      }
      .approval-item p {
        color: #666;
        font-size: 13px;
        margin-bottom: 8px;
      }
      .approval-actions {
        display: flex;
        gap: 10px;
      }
      .btn-approve {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-approve:hover {
        background: #218838;
      }
      .btn-reject {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-reject:hover {
        background: #c82333;
      }
      .no-data {
        text-align: center;
        color: #999;
        padding: 40px 20px;
      }
      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }
        .navbar {
          flex-direction: column;
          gap: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <h1>ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
      <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="container">
      <!-- Profile Section -->
      <div class="grid">
        <div class="profile-card">
          <div class="profile-image" id="profileImageDiv">ğŸ‘¤</div>
          <div class="profile-info">
            <h2 id="userName"></h2>
            <p id="userUsername"></p>
            <p id="userEmail"></p>
          </div>
          <div class="bio" id="userBio"></div>
          <p style="color: #999; font-size: 12px" id="joinDate"></p>
        </div>

        <!-- Messages Section -->
        <div>
          <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('inbox')">
              Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
            </button>
            <button class="tab-btn" onclick="switchTab('admin')">
              Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
            </button>
          </div>

          <!-- Inbox -->
          <div id="inbox" class="tab-content active">
            <h3>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
            <div id="messagesList"></div>
          </div>

          <!-- Admin Panel -->
          <div id="admin" class="tab-content">
            <h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
            <div id="adminPanel"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "https://admin999.pythonanywhere.com/api";

      // Check authentication
      function checkAuth() {
        if (!localStorage.getItem("token")) {
          window.location.href = "login.html";
        }
      }

      // Load user profile
      async function loadProfile() {
        try {
          const res = await fetch(`${API_URL}/user/profile`, {
            headers: { Authorization: localStorage.getItem("token") },
          });
          if (!res.ok) throw new Error("Failed to load profile");

          const user = await res.json();
          document.getElementById("userName").textContent =
            user.full_name || user.username;
          document.getElementById(
            "userUsername"
          ).textContent = `@${user.username}`;
          document.getElementById("userEmail").textContent = user.email;
          document.getElementById("userBio").textContent =
            user.bio || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø¨Ø°Ø©";
          document.getElementById(
            "joinDate"
          ).textContent = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: ${new Date(
            user.created_at
          ).toLocaleDateString("ar-SA")}`;

          // Load profile image if exists
          if (user.profile_image && user.profile_image.startsWith("data:")) {
            const img = document.createElement("img");
            img.src = user.profile_image;
            document.getElementById("profileImageDiv").innerHTML = "";
            document.getElementById("profileImageDiv").appendChild(img);
          }
        } catch (e) {
          console.error("Error loading profile:", e);
        }
      }

      // Load messages
      async function loadMessages() {
        try {
          const res = await fetch(`${API_URL}/messages/inbox`, {
            headers: { Authorization: localStorage.getItem("token") },
          });
          if (!res.ok) throw new Error("Failed to load messages");

          const messages = await res.json();
          const container = document.getElementById("messagesList");

          if (!messages || messages.length === 0) {
            container.innerHTML = '<div class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</div>';
            return;
          }

          container.innerHTML = messages
            .map(
              (msg) => `
                    <div class="message-item">
                        <div class="message-header">
                            <strong>${msg.sender_name || "Ù…Ø±Ø³Ù„ Ù…Ø¬Ù‡ÙˆÙ„"}</strong>
                            <span>${new Date(msg.created_at).toLocaleDateString(
                              "ar-SA"
                            )}</span>
                        </div>
                        <div style="margin-bottom: 8px; font-weight: 600; color: #667eea;">${
                          msg.subject || "Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¶ÙˆØ¹"
                        }</div>
                        <div class="message-body">${
                          msg.content || "Ù…Ø­ØªÙˆÙ‰ ÙØ§Ø±Øº"
                        }</div>
                    </div>
                `
            )
            .join("");
        } catch (e) {
          console.error("Error loading messages:", e);
        }
      }

      // Load admin panel (if admin)
      async function loadAdminPanel() {
        const token = localStorage.getItem("token");
        if (!token) return;

        try {
          const res = await fetch(`${API_URL}/admin/pending-registrations`, {
            headers: { Authorization: token },
          });

          if (res.status === 403) {
            document.getElementById("adminPanel").innerHTML =
              '<p style="color: #999;">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©</p>';
            return;
          }

          if (!res.ok) throw new Error("Failed to load pending registrations");

          const pending = await res.json();
          const container = document.getElementById("adminPanel");

          if (!pending || pending.length === 0) {
            container.innerHTML =
              '<div class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</div>';
            return;
          }

          container.innerHTML = pending
            .map(
              (req) => `
                    <div class="approval-item">
                        <h4>${req.full_name}</h4>
                        <p><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${req.username}</p>
                        <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> ${req.email}</p>
                        <p><strong>Ø§Ù„Ù†Ø¨Ø°Ø©:</strong> ${
                          req.bio || "Ø¨Ø¯ÙˆÙ† Ù†Ø¨Ø°Ø©"
                        }</p>
                        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</strong> ${new Date(
                          req.created_at
                        ).toLocaleDateString("ar-SA")}</p>
                        <div class="approval-actions">
                            <button class="btn-approve" onclick="approveRegistration(${
                              req.id
                            })">âœ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</button>
                            <button class="btn-reject" onclick="rejectRegistration(${
                              req.id
                            })">âŒ Ø§Ù„Ø±ÙØ¶</button>
                        </div>
                    </div>
                `
            )
            .join("");
        } catch (e) {
          console.error("Error loading admin panel:", e);
        }
      }

      // Approve registration
      async function approveRegistration(id) {
        try {
          const res = await fetch(
            `${API_URL}/admin/approve-registration/${id}`,
            {
              method: "POST",
              headers: { Authorization: localStorage.getItem("token") },
            }
          );
          if (res.ok) {
            alert("âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨");
            loadAdminPanel();
          } else {
            alert("âŒ ÙØ´Ù„: " + (await res.json()).error);
          }
        } catch (e) {
          alert("Ø®Ø·Ø£: " + e.message);
        }
      }

      // Reject registration
      async function rejectRegistration(id) {
        const reason = prompt("Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):");
        try {
          const res = await fetch(
            `${API_URL}/admin/reject-registration/${id}`,
            {
              method: "POST",
              headers: { Authorization: localStorage.getItem("token") },
              body: JSON.stringify({ reason: reason || "" }),
            }
          );
          if (res.ok) {
            alert("âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨");
            loadAdminPanel();
          } else {
            alert("âŒ ÙØ´Ù„: " + (await res.json()).error);
          }
        } catch (e) {
          alert("Ø®Ø·Ø£: " + e.message);
        }
      }

      // Switch tabs
      function switchTab(tab) {
        document
          .querySelectorAll(".tab-content")
          .forEach((el) => el.classList.remove("active"));
        document
          .querySelectorAll(".tab-btn")
          .forEach((el) => el.classList.remove("active"));

        document.getElementById(tab).classList.add("active");
        event.target.classList.add("active");

        if (tab === "admin") {
          loadAdminPanel();
        }
      }

      // Logout
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user_id");
        localStorage.removeItem("username");
        window.location.href = "welcome.html";
      }

      // Initialize
      checkAuth();
      loadProfile();
      loadMessages();
    </script>
  </body>
</html>
