<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
        direction: rtl;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 24px;
      }

      .user-info {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .logout-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid white;
        color: white;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .logout-btn:hover {
        background: white;
        color: #667eea;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .stat-card h3 {
        color: #666;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .stat-card .number {
        font-size: 32px;
        font-weight: bold;
        color: #667eea;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
      }

      .sidebar {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        height: fit-content;
      }

      .menu {
        list-style: none;
      }

      .menu li {
        margin-bottom: 10px;
      }

      .menu a {
        display: block;
        padding: 12px;
        color: #333;
        text-decoration: none;
        border-radius: 5px;
        transition: all 0.3s;
        cursor: pointer;
      }

      .menu a:hover,
      .menu a.active {
        background: #667eea;
        color: white;
      }

      .content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .section {
        display: none;
      }

      .section.active {
        display: block;
      }

      .messages-list {
        max-height: 500px;
        overflow-y: auto;
      }

      .message-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: all 0.3s;
      }

      .message-item:hover {
        background: #f5f5f5;
      }

      .message-item.unread {
        background: #f0f4ff;
        border-right: 4px solid #667eea;
        padding-right: 11px;
      }

      .message-sender {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
      }

      .message-preview {
        color: #666;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 5px;
      }

      .message-time {
        font-size: 12px;
        color: #999;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: #333;
        font-weight: 500;
      }

      input[type="text"],
      input[type="email"],
      textarea,
      select {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        font-family: inherit;
        transition: all 0.3s;
      }

      input[type="text"]:focus,
      input[type="email"]:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 5px rgba(102, 126, 234, 0.1);
      }

      textarea {
        resize: vertical;
        min-height: 120px;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .message {
        padding: 12px;
        border-radius: 5px;
        margin-bottom: 15px;
        display: none;
      }

      .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        display: block;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        display: block;
      }

      .contacts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
      }

      .contact-card {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }

      .contact-card:hover {
        background: #667eea;
        color: white;
        transform: translateY(-5px);
      }

      .contact-name {
        font-weight: 600;
        margin-bottom: 5px;
      }

      .contact-username {
        font-size: 12px;
        opacity: 0.7;
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .header-content {
          flex-direction: column;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
        <div class="user-info">
          <span id="username">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
          <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="stats">
        <div class="stat-card">
          <h3>ğŸ“¨ Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©</h3>
          <div class="number" id="unreadCount">0</div>
        </div>
        <div class="stat-card">
          <h3>ğŸ‘¥ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h3>
          <div class="number" id="contactsCount">0</div>
        </div>
        <div class="stat-card">
          <h3>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</h3>
          <div class="number" id="joinDate">-</div>
        </div>
      </div>

      <div class="main-content">
        <div class="sidebar">
          <ul class="menu">
            <li>
              <a class="menu-item active" onclick="showSection('inbox')"
                >ğŸ“¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</a
              >
            </li>
            <li>
              <a class="menu-item" onclick="showSection('outbox')"
                >ğŸ“¤ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</a
              >
            </li>
            <li>
              <a class="menu-item" onclick="showSection('send')"
                >âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©</a
              >
            </li>
            <li>
              <a class="menu-item" onclick="showSection('contacts')"
                >ğŸ‘¥ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</a
              >
            </li>
            <li>
              <a class="menu-item" onclick="showSection('profile')"
                >ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a
              >
            </li>
          </ul>
        </div>

        <div class="content">
          <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© -->
          <div id="inbox" class="section active">
            <h2>ğŸ“¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h2>
            <div id="message-inbox" class="message"></div>
            <div id="inboxList" class="messages-list">
              <p style="text-align: center; color: #999; padding: 20px">
                Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
              </p>
            </div>
          </div>

          <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø© -->
          <div id="outbox" class="section">
            <h2>ğŸ“¤ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</h2>
            <div id="message-outbox" class="message"></div>
            <div id="outboxList" class="messages-list">
              <p style="text-align: center; color: #999; padding: 20px">
                Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
              </p>
            </div>
          </div>

          <!-- Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© -->
          <div id="send" class="section">
            <h2>âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <div id="message-send" class="message"></div>

            <div class="form-group">
              <label>Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„</label>
              <input
                type="text"
                id="searchUser"
                placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..."
              />
              <div id="searchResults" style="margin-top: 10px"></div>
            </div>

            <form
              id="sendMessageForm"
              style="
                display: none;
                margin-top: 20px;
                border-top: 2px solid #eee;
                padding-top: 20px;
              "
            >
              <div class="form-group">
                <label>Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„:</label>
                <input
                  type="text"
                  id="receiverInfo"
                  readonly
                  style="background: #f5f5f5"
                />
              </div>

              <div class="form-group">
                <label>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="text" id="subject" placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©" />
              </div>

              <div class="form-group">
                <label>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                <textarea
                  id="messageContent"
                  placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."
                  required
                ></textarea>
              </div>

              <button type="submit" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
              <button
                type="button"
                class="btn"
                style="background: #999; margin-right: 10px"
                onclick="cancelSend()"
              >
                Ø¥Ù„ØºØ§Ø¡
              </button>
            </form>
          </div>

          <!-- Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ -->
          <div id="contacts" class="section">
            <h2>ğŸ‘¥ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h2>
            <div id="contactsList" class="contacts-grid">
              <p
                style="
                  grid-column: 1/-1;
                  text-align: center;
                  color: #999;
                  padding: 20px;
                "
              >
                Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
              </p>
            </div>
          </div>

          <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
          <div id="profile" class="section">
            <h2>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>
            <div id="profileInfo"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API Ø¹Ù„Ù‰ PythonAnywhere
      const API_URL = "https://admin999.pythonanywhere.com/api";
      // Ø¯Ø¹Ù… ÙƒÙ„Ø§ Ø§Ù„Ù†ÙˆØ¹ÙŠÙ† Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
      let sessionToken =
        localStorage.getItem("token") || localStorage.getItem("sessionToken");
      let userId =
        localStorage.getItem("user_id") || localStorage.getItem("userId");
      let username = localStorage.getItem("username");
      let selectedReceiver = null;

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      if (!sessionToken) {
        window.location.href = "login.html";
      }

      // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      document.getElementById("username").textContent = username || "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      window.addEventListener("load", () => {
        loadProfile();
        loadInbox();
        loadOutbox();
        loadContacts();
        setupSearchUsers();
      });

      // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      function showSection(sectionId) {
        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        document
          .querySelectorAll(".section")
          .forEach((s) => s.classList.remove("active"));
        document
          .querySelectorAll(".menu-item")
          .forEach((m) => m.classList.remove("active"));

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±
        document.getElementById(sectionId).classList.add("active");
        event.target.classList.add("active");

        if (sectionId === "inbox") loadInbox();
        if (sectionId === "outbox") loadOutbox();
        if (sectionId === "contacts") loadContacts();
        if (sectionId === "profile") loadProfile();
      }

      function logout() {
        localStorage.clear();
        window.location.href = "login.html";
      }

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
      async function loadProfile() {
        try {
          const response = await fetch(`${API_URL}/user/profile`, {
            headers: {
              Authorization: `Bearer ${sessionToken}`,
            },
          });

          const data = await response.json();

          if (response.ok) {
            const user = data.user;
            const stats = data.stats;

            document.getElementById("unreadCount").textContent =
              stats.unread_messages;
            document.getElementById("contactsCount").textContent =
              stats.contacts_count;

            const joinDate = new Date(user.created_at).toLocaleDateString(
              "ar-SA"
            );
            document.getElementById("joinDate").textContent = joinDate;

            const profileInfo = `
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 5px;">
                            <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${user.username}</p>
                            <p><strong>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</strong> ${user.full_name}</p>
                            <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> ${user.email}</p>
                            <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</strong> ${joinDate}</p>
                        </div>
                    `;
            document.getElementById("profileInfo").innerHTML = profileInfo;
          }
        } catch (error) {
          console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ:", error);
        }
      }

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
      async function loadInbox() {
        try {
          const response = await fetch(`${API_URL}/messages/inbox`, {
            headers: {
              Authorization: `Bearer ${sessionToken}`,
            },
          });

          const data = await response.json();

          if (response.ok && data.messages.length > 0) {
            let html = "";
            data.messages.forEach((msg) => {
              const time = new Date(msg.created_at).toLocaleString("ar-SA");
              const unreadClass = !msg.is_read ? "unread" : "";
              html += `
                            <div class="message-item ${unreadClass}">
                                <div class="message-sender">Ù…Ù†: ${
                                  msg.full_name
                                }</div>
                                <div class="message-preview">${msg.content.substring(
                                  0,
                                  50
                                )}...</div>
                                <div class="message-time">${time}</div>
                            </div>
                        `;
            });
            document.getElementById("inboxList").innerHTML = html;
          } else if (data.messages.length === 0) {
            document.getElementById("inboxList").innerHTML =
              '<p style="text-align: center; color: #999; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ø±Ø¯Ø©</p>';
          }
        } catch (error) {
          console.error("Ø®Ø·Ø£:", error);
          document.getElementById("message-inbox").innerHTML =
            "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„";
          document.getElementById("message-inbox").className = "message error";
        }
      }

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø©
      async function loadOutbox() {
        try {
          const response = await fetch(`${API_URL}/messages/outbox`, {
            headers: {
              Authorization: `Bearer ${sessionToken}`,
            },
          });

          const data = await response.json();

          if (response.ok && data.messages.length > 0) {
            let html = "";
            data.messages.forEach((msg) => {
              const time = new Date(msg.created_at).toLocaleString("ar-SA");
              html += `
                            <div class="message-item">
                                <div class="message-sender">Ø¥Ù„Ù‰: ${
                                  msg.full_name
                                }</div>
                                <div class="message-preview">${msg.content.substring(
                                  0,
                                  50
                                )}...</div>
                                <div class="message-time">${time}</div>
                            </div>
                        `;
            });
            document.getElementById("outboxList").innerHTML = html;
          } else if (data.messages.length === 0) {
            document.getElementById("outboxList").innerHTML =
              '<p style="text-align: center; color: #999; padding: 20px;">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø£ÙŠ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</p>';
          }
        } catch (error) {
          console.error("Ø®Ø·Ø£:", error);
        }
      }

      // ØªØ­Ù…ÙŠÙ„ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
      async function loadContacts() {
        try {
          const response = await fetch(`${API_URL}/contacts`, {
            headers: {
              Authorization: `Bearer ${sessionToken}`,
            },
          });

          const data = await response.json();

          if (response.ok && data.contacts.length > 0) {
            let html = "";
            data.contacts.forEach((contact) => {
              html += `
                            <div class="contact-card" onclick="selectContactAndSend(${contact.id}, '${contact.full_name}')">
                                <div class="contact-name">${contact.full_name}</div>
                                <div class="contact-username">@${contact.username}</div>
                            </div>
                        `;
            });
            document.getElementById("contactsList").innerHTML = html;
          } else if (data.contacts.length === 0) {
            document.getElementById("contactsList").innerHTML =
              '<p style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯</p>';
          }
        } catch (error) {
          console.error("Ø®Ø·Ø£:", error);
        }
      }

      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      function setupSearchUsers() {
        const searchInput = document.getElementById("searchUser");
        const searchResults = document.getElementById("searchResults");

        searchInput.addEventListener("input", async (e) => {
          const query = e.target.value.trim();

          if (query.length < 2) {
            searchResults.innerHTML = "";
            return;
          }

          try {
            const response = await fetch(
              `${API_URL}/users/search?q=${encodeURIComponent(query)}`,
              {
                headers: {
                  Authorization: `Bearer ${sessionToken}`,
                },
              }
            );

            const data = await response.json();

            if (response.ok && data.users.length > 0) {
              let html = "";
              data.users.forEach((user) => {
                html += `
                                <div class="contact-card" style="margin-bottom: 5px;" onclick="selectReceiver(${user.id}, '${user.full_name}', '@${user.username}')">
                                    <div class="contact-name">${user.full_name}</div>
                                    <div class="contact-username">@${user.username}</div>
                                </div>
                            `;
              });
              searchResults.innerHTML = html;
            } else {
              searchResults.innerHTML =
                '<p style="color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
            }
          } catch (error) {
            console.error("Ø®Ø·Ø£:", error);
          }
        });
      }

      // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      function selectReceiver(receiverId, receiverName, receiverUsername) {
        selectedReceiver = {
          id: receiverId,
          name: receiverName,
          username: receiverUsername,
        };

        document.getElementById(
          "receiverInfo"
        ).value = `${receiverName} (${receiverUsername})`;
        document.getElementById("sendMessageForm").style.display = "block";
        document.getElementById("searchResults").innerHTML = "";
        document.getElementById("searchUser").value = "";
      }

      function selectContactAndSend(receiverId, receiverName) {
        showSection("send");
        selectReceiver(receiverId, receiverName, "");
        document.getElementById("searchUser").value = receiverName;
      }

      function cancelSend() {
        selectedReceiver = null;
        document.getElementById("sendMessageForm").style.display = "none";
        document.getElementById("messageContent").value = "";
        document.getElementById("subject").value = "";
        document.getElementById("receiverInfo").value = "";
      }

      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      document
        .getElementById("sendMessageForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!selectedReceiver) {
            showMessage("send", "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ø£ÙˆÙ„Ø§", "error");
            return;
          }

          const subject = document.getElementById("subject").value.trim();
          const content = document
            .getElementById("messageContent")
            .value.trim();

          if (!content) {
            showMessage("send", "Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø·Ù„ÙˆØ¨", "error");
            return;
          }

          try {
            const response = await fetch(`${API_URL}/messages/send`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${sessionToken}`,
              },
              body: JSON.stringify({
                receiver_id: selectedReceiver.id,
                subject: subject,
                content: content,
              }),
            });

            const data = await response.json();

            if (response.ok) {
              showMessage("send", "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!", "success");
              cancelSend();
              setTimeout(() => {
                loadOutbox();
              }, 1000);
            } else {
              showMessage("send", "âŒ " + data.error, "error");
            }
          } catch (error) {
            showMessage("send", "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message, "error");
          }
        });

      function showMessage(section, msg, type) {
        const messageDiv = document.getElementById(`message-${section}`);
        messageDiv.textContent = msg;
        messageDiv.className = `message ${type}`;
        setTimeout(() => {
          messageDiv.className = "message";
        }, 5000);
      }
    </script>
  </body>
</html>
